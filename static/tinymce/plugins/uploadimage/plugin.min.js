/**
 * tinymce plugin
 * Created by skye on 17/5/18.
 */
tinymce.PluginManager.add('uploadimage', function (editor) {

    function selectLocalImages() {
        var dom = editor.dom;
        var F = document.createElement('input')
        F.setAttribute('type', 'file')
        F.setAttribute('name', 'thumbnail')
        F.setAttribute('accept', 'image/jpg,image/jpeg,image/png,image/gif')
        F.setAttribute('multiple', 'multiple')

        F.addEventListener('change', function () {
            var formData = new FormData();
            var xhr = new XMLHttpRequest()
            formData.append('file', this.files[0])
            xhr.open('POST', editor.settings.upload_image_url)
            xhr.send(formData)
            xhr.onload = function () {
                if (this.status == 200 || this.status == 304) {
                    editor.focus();
                    editor.selection.setContent(dom.createHTML('img', {'src': JSON.parse(xhr.responseText).data.url}));
                }
            }
            xhr.onerror = function (err) {
                console.log(err)
            }
        });

        F.click();
    }

    editor.addCommand("mceUploadImageEditor", selectLocalImages);

    editor.addButton('uploadimage', {
        icon: 'image',
        tooltip: '上传图片',
        onclick: selectLocalImages
    });

    editor.addMenuItem('uploadimage', {
        icon: 'image',
        text: '上传图片',
        context: 'tools',
        onclick: selectLocalImages
    });
});