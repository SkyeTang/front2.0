/**
 * tinymce plugin
 * Created by jerry on 16/8/5.
 */
tinymce.PluginManager.add('uploadimage', function (editor) {

    function selectLocalImages() {
        var dom = editor.dom;
        var input_f = document.createElement('input')
        input_f.setAttribute('type', 'file')
        input_f.setAttribute('name', 'thumbnail')
        input_f.setAttribute('accept', 'image/jpg,image/jpeg,image/png,image/gif')
        input_f.setAttribute('multiple', 'multiple')
        input_f.addEventListener('change', function () {
            var form = document.createElement('form')
            form.setAttribute('action', editor.settings.upload_image_url)
            form.setAttribute('style', 'display:none')
            form.setAttribute('method', 'post')
            form.setAttribute('enctype', 'multipart/form-data')
            form.append(input_f);
            //ajax提交表单
            form.ajaxSubmit({
                beforeSubmit: function () {
                    return true;
                },
                success: function (data) {
                    if (data && data.file_path) {
                        editor.focus();
                        data.file_path.forEach(function (src) {
                            editor.selection.setContent(dom.createHTML('img', {src: src}));
                        })
                    }
                }
            });
        });

        input_f.click();
    }

    editor.addCommand("mceUploadImageEditor", selectLocalImages);

    editor.addButton('uploadimage', {
        icon: 'image',
        tooltip: '上传图片',
        onclick: selectLocalImages
    });

    editor.addMenuItem('uploadimage', {
        icon: 'image',
        text: '上传图片',
        context: 'tools',
        onclick: selectLocalImages
    });
});